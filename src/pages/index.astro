<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acceso</title>
    <link rel="stylesheet" href="/styles/captcha.css" />
    <link rel="stylesheet" href="/styles/auth.css" />
  </head>

  <body>
    <main class="wrap">
      <h1>Acceso</h1>
      <p class="sub">Regístrate o inicia sesión. Después podrás completar la verificación humana.</p>

      <!-- AUTH -->
      <section class="authCard" aria-label="Autenticación">
        <div class="authTabs">
          <button id="tabLogin" class="authTab active" type="button">Iniciar sesión</button>
          <button id="tabRegister" class="authTab" type="button">Registrarme</button>
        </div>

        <!-- Login -->
        <form id="loginForm" class="authForm" autocomplete="off" novalidate>
          <div class="authRow">
            <label class="authLabel" for="loginNombre">Nombre</label>
            <input class="authInput" id="loginNombre" name="nombre" required minlength="2" placeholder="Tu nombre" />
          </div>

          <div class="authRow">
            <label class="authLabel" for="loginPass">Contraseña</label>
            <input class="authInput" id="loginPass" name="pass" type="password" required placeholder="********" />
          </div>

          <button id="loginBtn" class="authBtn" type="submit">Entrar</button>
          <p id="authMsg" class="authMsg" role="status" aria-live="polite"></p>
        </form>

        <!-- Registro -->
        <form id="registerForm" class="authForm hidden" autocomplete="off" novalidate>
          <div class="authRow">
            <label class="authLabel" for="regNombre">Nombre</label>
            <input class="authInput" id="regNombre" name="nombre" required minlength="2" placeholder="Ej. Juan" />
          </div>

          <div class="authRow">
            <label class="authLabel" for="regPass">Contraseña</label>
            <input class="authInput" id="regPass" name="pass" type="password" required placeholder="********" />
            <small class="authHelp">Debe tener 8+ caracteres e incluir mayúscula, minúscula y número.</small>
          </div>

          <div class="authRow">
            <label class="authLabel" for="regPass2">Confirmar contraseña</label>
            <input class="authInput" id="regPass2" name="pass2" type="password" required placeholder="********" />
          </div>

          <button id="regBtn" class="authBtn" type="submit">Crear cuenta</button>
          <p id="regMsg" class="authMsg" role="status" aria-live="polite"></p>
        </form>
      </section>

      <!-- CAPTCHA (bloqueado hasta login) -->
      <section class="widget" aria-label="Verificación" id="captchaSection" data-locked="true">
        <div class="widgetTop">
          <div class="left">
            <div class="checkbox" title="Marcar verificación">
              <input id="check" type="checkbox" disabled />
            </div>

            <div class="titleLine">
              <strong>No soy un robot</strong>
              <span id="captchaHint">Inicia sesión para habilitar la verificación</span>
            </div>
          </div>

          <div class="right">
            <div id="spin" class="spinner" aria-hidden="true"></div>

            <div class="badge">
              <div class="brand">reCAPTCHA</div>
              <div class="links">
                <a href="#" onclick="return false;">Privacidad</a>
                ·
                <a href="#" onclick="return false;">Términos</a>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <form id="f" class="challenge hidden">
          <p id="q" class="question">Cargando reto…</p>

          <div class="row2">
            <input
              class="input"
              name="answer"
              id="answer"
              inputmode="numeric"
              autocomplete="off"
              placeholder="Respuesta"
              required
            />
            <button id="btn" class="btn" type="submit">Continuar</button>
          </div>

          <p id="msg" class="msg" role="status" aria-live="polite"></p>
        </form>
      </section>
    </main>

    <script type="module">
      import { goError } from "/scripts/goError.js";

      // ===== refs tabs/forms =====
      const tabLogin = document.getElementById("tabLogin");
      const tabRegister = document.getElementById("tabRegister");
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");

      const authMsg = document.getElementById("authMsg");
      const regMsg = document.getElementById("regMsg");
      const loginBtn = document.getElementById("loginBtn");
      const regBtn = document.getElementById("regBtn");

      // ===== helpers =====
      function setMsg(el, text, type = "") {
        if (!el) return;
        el.textContent = text || "";
        el.classList.remove("ok", "err");
        if (type) el.classList.add(type);
      }

      function clearForm(formEl) {
        if (!(formEl instanceof HTMLFormElement)) return;
        formEl.reset();
        // limpia el mensaje dentro del form (si existe)
        const localMsg = formEl.querySelector(".authMsg");
        if (localMsg) localMsg.textContent = "";
      }

      function showLogin() {
        tabLogin?.classList.add("active");
        tabRegister?.classList.remove("active");
        loginForm?.classList.remove("hidden");
        registerForm?.classList.add("hidden");

        // ✅ no guardar datos
        clearForm(registerForm);
        clearForm(loginForm);
        setMsg(authMsg, "");
        setMsg(regMsg, "");
      }

      function showRegister() {
        tabRegister?.classList.add("active");
        tabLogin?.classList.remove("active");
        registerForm?.classList.remove("hidden");
        loginForm?.classList.add("hidden");

        // ✅ no guardar datos
        clearForm(loginForm);
        clearForm(registerForm);
        setMsg(authMsg, "");
        setMsg(regMsg, "");
      }

      tabLogin?.addEventListener("click", showLogin);
      tabRegister?.addEventListener("click", showRegister);

      // ===== captcha refs =====
      const captchaSection = document.getElementById("captchaSection");
      const check = document.getElementById("check");
      const form = document.getElementById("f");
      const q = document.getElementById("q");
      const msg = document.getElementById("msg");
      const answer = document.getElementById("answer");
      const spin = document.getElementById("spin");
      const btn = document.getElementById("btn");
      const captchaHint = document.getElementById("captchaHint");

      const setCaptchaMsg = (text, type = "muted") => {
        if (!msg) return;
        msg.textContent = text;
        msg.classList.remove("err", "ok");
        if (type === "err") msg.classList.add("err");
        if (type === "ok") msg.classList.add("ok");
      };

      function unlockCaptcha() {
        if (check instanceof HTMLInputElement) check.disabled = false;
        if (captchaHint) captchaHint.textContent = "Completa el reto rápido para continuar";
        captchaSection?.setAttribute("data-locked", "false");
      }

      // ===== REGISTRO =====
      registerForm?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nombre = String(document.getElementById("regNombre")?.value ?? "").trim();
        const pass = String(document.getElementById("regPass")?.value ?? "");
        const pass2 = String(document.getElementById("regPass2")?.value ?? "");

        if (!nombre || nombre.length < 2) {
          setMsg(regMsg, "❌ Usuario inválido.", "err");
          return;
        }
        if (!pass) {
          setMsg(regMsg, "❌ Contraseña inválida.", "err");
          return;
        }
        if (pass !== pass2) {
          setMsg(regMsg, "❌ Las contraseñas no coinciden.", "err");
          return;
        }

        if (regBtn instanceof HTMLButtonElement) regBtn.disabled = true;
        setMsg(regMsg, "Registrando...");

        try {
          const res = await fetch("/api/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({ nombre, pass }),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok || !data.ok) {
            // Mensaje exacto viene del backend
            setMsg(regMsg, "❌ " + (data.message || "No se pudo registrar."), "err");
            return;
          }

          setMsg(regMsg, "✅ Registro exitoso. Ahora inicia sesión.", "ok");

          // ✅ cambiar a login y limpiar ambos
          showLogin();
        } catch {
          goError("Error de red al registrar.", "E_REG_NET");
        } finally {
          if (regBtn instanceof HTMLButtonElement) regBtn.disabled = false;
        }
      });

      // ===== LOGIN =====
      loginForm?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nombre = String(document.getElementById("loginNombre")?.value ?? "").trim();
        const pass = String(document.getElementById("loginPass")?.value ?? "");

        if (!nombre || nombre.length < 2) {
          setMsg(authMsg, "❌ Usuario inválido.", "err");
          return;
        }
        if (!pass) {
          setMsg(authMsg, "❌ Contraseña inválida.", "err");
          return;
        }

        if (loginBtn instanceof HTMLButtonElement) loginBtn.disabled = true;
        setMsg(authMsg, "Iniciando sesión...");

        try {
          const res = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({ nombre, pass }),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok || !data.ok) {
            // Mensaje exacto viene del backend
            setMsg(authMsg, "❌ " + (data.message || "No se pudo iniciar sesión."), "err");
            return;
          }

          setMsg(authMsg, "✅ Sesión iniciada. Completa la verificación.", "ok");
          unlockCaptcha();
        } catch {
          goError("Error de red al iniciar sesión.", "E_LOGIN_NET");
        } finally {
          if (loginBtn instanceof HTMLButtonElement) loginBtn.disabled = false;
        }
      });

      // ===== CAPTCHA =====
      if (
        !(check instanceof HTMLInputElement) ||
        !(form instanceof HTMLFormElement) ||
        !(q instanceof HTMLElement) ||
        !(answer instanceof HTMLInputElement) ||
        !(spin instanceof HTMLElement) ||
        !(btn instanceof HTMLButtonElement) ||
        !(msg instanceof HTMLParagraphElement)
      ) {
        console.error("Faltan elementos del DOM para el captcha");
      } else {
        async function loadChallenge() {
          setCaptchaMsg("");
          q.textContent = "Cargando reto…";

          const res = await fetch("/api/human-challenge", { credentials: "same-origin" });
          const data = await res.json().catch(() => ({}));

          if (!res.ok || !data.ok) {
            goError(data.message || "No se pudo cargar el reto.", data.code || "E_CAPTCHA_LOAD");
            return;
          }

          q.textContent = data.question;
        }

        check.addEventListener("change", async () => {
          if (check.disabled) {
            check.checked = false;
            return;
          }

          if (check.checked) {
            form.classList.remove("hidden");
            await loadChallenge();
            answer.focus();
            setCaptchaMsg("Resuelve el reto para continuar.");
          } else {
            form.classList.add("hidden");
            setCaptchaMsg("");
            answer.value = "";
          }
        });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          btn.disabled = true;
          spin.style.display = "inline-block";
          setCaptchaMsg("Verificando…");

          const fd = new FormData(form);
          const res = await fetch("/api/human-verify", {
            method: "POST",
            credentials: "same-origin",
            body: fd,
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok || !data.ok) {
            window.location.href =
              "/error?msg=" +
              encodeURIComponent(data.message || "Verificación fallida. Intenta nuevamente.") +
              "&code=" +
              encodeURIComponent(data.code || "E_CAPTCHA_BAD") +
              "&retry=captcha";
            return;
          }

          setCaptchaMsg("✅ Verificado. Redirigiendo…", "ok");
          window.location.href = data.redirectTo || "/home";
        });
      }
    </script>
  </body>
</html>
