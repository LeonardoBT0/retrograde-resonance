<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verificación humana</title>
    <link rel="stylesheet" href="/styles/captcha.css" />
  </head>

  <body>
    <main class="wrap">
      <h1>Verificación humana</h1>
      <p class="sub">Confirma que eres humano para continuar al inicio.</p>

      <section class="widget" aria-label="Verificación">
        <div class="widgetTop">
          <div class="left">
            <div class="checkbox" title="Marcar verificación">
              <input id="check" type="checkbox" />
            </div>

            <div class="titleLine">
              <strong>No soy un robot</strong>
              <span>Completa el reto rápido para continuar</span>
            </div>
          </div>

          <div class="right">
            <div id="spin" class="spinner" aria-hidden="true"></div>

            <div class="badge">
              <div class="brand">reCAPTCHA</div>
              <div class="links">
                <a href="#" onclick="return false;">Privacidad</a>
                ·
                <a href="#" onclick="return false;">Términos</a>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <form id="f" class="challenge hidden">
          <p id="q" class="question">Cargando reto…</p>

          <div class="row2">
            <input
              class="input"
              name="answer"
              id="answer"
              inputmode="numeric"
              autocomplete="off"
              placeholder="Respuesta"
              required
            />
            <button id="btn" class="btn" type="submit">Continuar</button>
          </div>

          <p id="msg" class="msg" role="status" aria-live="polite"></p>
        </form>
      </section>
    </main>

    <script>
      const check = document.getElementById("check");
      const form = document.getElementById("f");
      const q = document.getElementById("q");
      const msg = document.getElementById("msg");
      const answer = document.getElementById("answer");
      const spin = document.getElementById("spin");
      const btn = document.getElementById("btn");

      if (
        !(check instanceof HTMLInputElement) ||
        !(form instanceof HTMLFormElement) ||
        !(q instanceof HTMLElement) ||
        !(msg instanceof HTMLParagraphElement) ||
        !(answer instanceof HTMLInputElement) ||
        !(spin instanceof HTMLElement) ||
        !(btn instanceof HTMLButtonElement)
      ) {
        console.error("Faltan elementos del DOM para el captcha");
      } else {
        const setMsg = (text, type = "muted") => {
          msg.textContent = text;
          msg.classList.remove("err", "ok");
          if (type === "err") msg.classList.add("err");
          if (type === "ok") msg.classList.add("ok");
        };

        async function loadChallenge() {
          setMsg("");
          q.textContent = "Cargando reto…";
          const res = await fetch("/api/human-challenge");
          const data = await res.json();
          q.textContent = data.question;
        }

        check.addEventListener("change", async () => {
          if (check.checked) {
            form.classList.remove("hidden");
            await loadChallenge();
            answer.focus();
            setMsg("Resuelve el reto para continuar.");
          } else {
            form.classList.add("hidden");
            setMsg("");
            answer.value = "";
          }
        });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          btn.disabled = true;
          spin.style.display = "inline-block";
          setMsg("Verificando…");

          const fd = new FormData(form);
          const res = await fetch("/api/human-verify", { method: "POST", body: fd });
          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            setMsg("❌ " + (data.message || "Error"), "err");
            await loadChallenge();
            answer.value = "";
            answer.focus();
            btn.disabled = false;
            spin.style.display = "none";
            return;
          }

          setMsg("✅ Verificado. Redirigiendo…", "ok");
          window.location.href = data.redirectTo || "/home";
        });
      }
    </script>
  </body>
</html>
